<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
        <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
        <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
        <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

        <link rel="stylesheet" href="dashboard.css">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Poppins&display=swap');
        </style>
    </head>

    <body>
        <div class="summary">
            <div class="sumChild">
                <h5>All Pasar</h5>
                <div class="loadingselect ld1" hidden>
                    <div class="lds-facebook"><div></div><div></div><div></div></div>
                </div>  
            </div>
            <div class="sumChild">
                <h5>All Wilayah</h5>
                <div class="loadingselect ld2" hidden>
                    <div class="lds-facebook"><div></div><div></div><div></div></div>
                </div>  
            </div>
        </div>
        <div class="container">
            <div class="selectMenu">
                <select name="kat" id="kat">
                    <option value="">-- Pilih Kategori --</option>
                    <option value="pasar">Pasar</option>
                    <option value="wilayah">Wilayah</option>
                </select>

                <select name="detailKat" id="detailKat">

                </select>
            </div>

            <div class="loadingSelect ld0" hidden>
                <div class="lds-facebook"><div></div><div></div><div></div></div>
            </div>
        </div>

        <div class="resultDisplayer">
            <h5 id="JudulDetail"></h5>
        </div>

        <script>
            async function getWilayah() {
                const UrlKelurahan = "https://script.google.com/macros/s/AKfycbxxWf-43TUg5XvBOes_r89pANhi6fCOQgqhF_SwEmjJMWSIvv9BSDEsX2ZCpUGQDMRg/exec";

                let str = '';
                await fetch(UrlKelurahan)
                    .then(datas => datas.json())
                    .then(datas => {
                        const optionElemen = document.createElement('option');
                        optionElemen.value = '';
                        optionElemen.innerHTML = '---Pilih Kelurahan---';    
                        str += optionElemen.outerHTML;
                        if (datas.result === 'success') {
                            for (let k of datas.data) {
                                if (k[0] != 'Kelurahan') {
                                    let optionElemen = document.createElement('option');
                                    optionElemen.value = `${k[0]} - ${k[1]}`;
                                    optionElemen.innerHTML = k[0];
                                    str += optionElemen.outerHTML;
                                }
                            }
                        }
                });

                return str;
            }

            async function getPasar() {
                const urlDataPasar = "https://script.google.com/macros/s/AKfycbwzVP84YKO62g10ShP-DKAqmOieh8VMJv_8L1FG6ZldOUNPnNFTTZgEKid6d8B6Dx6n/exec";

                let str = '';
                await fetch(urlDataPasar)
                .then(datas => datas.json())
                .then(datas => {
                    const optionElemen = document.createElement('option');
                    optionElemen.value = '';
                    optionElemen.innerHTML = '---Pilih Pasar---';
                    str += optionElemen.outerHTML;

                    if (datas.result === 'success') {
                        for (let k of datas.data) {
                            if (k[0] != 'Daftar Pasar') {
                                let optionElemen = document.createElement('option');
                                optionElemen.value = k[0];
                                optionElemen.innerHTML = k[0];
                                str += optionElemen.outerHTML;
                            }
                        }
                    }
                });

                return str;

            }

            function clearResultDisplayer() {
                document.querySelector(".resultDisplayer").innerHTML = "";
            }

            async function getTotalStat() {
                //const apiUrl = "https://script.google.com/macros/s/AKfycbwnzTHBtbArremc3Ax8W4s7QHHFvoHRXAcRBsWFiQsgvWseclpV8Dz7kYQUxtLzTibu/exec";
                const apiUrl = "https://script.google.com/macros/s/AKfycbzgTJb8Uvva00j2KNLDFGTHtdRAVK__b52rWC5f9AIaeoMgmAdR-UZ7wBaOaNRgI-CW/exec";
                
                let a = {};
                await fetch(apiUrl, {
                    method : 'GET'
                })
                .then(data => data.json())
                .then(data => {
                    a = data;
                });

                return a;
            }

            async function getTotalStatWilayah() {
                //const apiUrl = "https://script.google.com/macros/s/AKfycbxnYR5ledPczSbnGXXbySjYxvxGpSPcjtAyuR4IzH1VJPvf7kKw3FyQou0gRXu1Lc1s/exec";
                const apiUrl = "https://script.google.com/macros/s/AKfycbwFc9WnhE6vBcyStokY4Z3gdmsSir1qGggQ-xKS2jnKdOf4xfyLnwJRZBIciJKMI-IB1A/exec";
                
                let a = {};
                await fetch(apiUrl, {
                    method : 'GET'
                })
                .then(data => data.json())
                .then(data => {
                    a = data;
                });

                return a;
            }

            async function getTotalStatPerPasar(namaPasar) {
                //const apiUrl = "https://script.google.com/macros/s/AKfycbyqx1UWFQxKCYmtHm5hqj7ySZds1qk8vtwxnlkQYEt-ff6xer3WtD5FWNYuMPw3BLB5/exec";
                
                const apiUrl = "https://script.google.com/macros/s/AKfycbyFL2mlam8gBdWGGyMjJH8PKoz0-lHZgGtOEWZK7E8rpFX2nQWWA-YPNkqzlCrC8mNS/exec";
                
                let a = {};
                await fetch(apiUrl, {
                    method : 'POST',
                    body : JSON.stringify({'pasar' : namaPasar})
                })
                .then(data => data.json())
                .then(data => {
                    a = data;
                });

                //console.log(a);
                return a;

            }

            (async function main() {
                //let dataTotalPerPasar = await getTotalStatPerPasar('Pasar Joglo');
                //console.log(dataTotalPerPasar);
                let loadingTotPsr = document.querySelector('.ld1');
                loadingTotPsr.hidden = false;
                let dataTotal = await getTotalStat();
                loadingTotPsr.hidden = true;
                let pasarDiv = document.getElementsByClassName('sumChild')[0];
                pasarDiv.innerHTML += `<table class='firstTable'>
                    <tr><td>Total Uttp</td><td>${dataTotal.totalStat.totalUttp} unit</td></tr>
                    <tr><td>Total Uttp Sdh Tera</td><td>${dataTotal.totalStat.totalUttpSdhTera} unit</td></tr>
                    <tr><td>Persen Uttp Sdh Tera</td><td>${dataTotal.totalStat.persenSdhTera} %</td></tr>
                </table>`;
                
                let str = `<table class='secondTable'><tr><th colspan=3 align="center">Jml Uttp Yang Belum Tera<th></tr>`;
                for (k in dataTotal.uttpAllObj) {
                    let persen = (dataTotal.uttpBlmTeraObj[k]/dataTotal.uttpAllObj[k])*100
                    str += `<tr><td>${k}</td><td>${persen.toFixed(2)} %</td><td>${dataTotal.uttpBlmTeraObj[k]}/${dataTotal.uttpAllObj[k]} unit</td></tr>`;
                }
                str += `</table>`;
                pasarDiv.innerHTML += str;
                
                //console.log(dataTotal);

                let loadingTotWly = document.querySelector('.ld2');
                loadingTotWly.hidden = false;
                let dataTotalWilayah = await getTotalStatWilayah();
                loadingTotWly.hidden = true;
                let wilayahDiv = document.getElementsByClassName('sumChild')[1];
                wilayahDiv.innerHTML += `<table class='firstTable'>
                    <tr><td>Total Uttp</td><td>${dataTotalWilayah.totalStat.totalUttp} unit</td></tr>
                    <tr><td>Total Uttp Sdh Tera</td><td>${dataTotalWilayah.totalStat.totalUttpSdhTera} unit</td></tr>
                    <tr><td>Persen Uttp Sdh Tera</td><td>${dataTotalWilayah.totalStat.persenSdhTera} %</td></tr>
                </table>`;
                
                let strWilayah = `<table class='secondTable'><tr><th colspan=3 align="center">Jml Uttp Yang Belum Tera<th></tr>`;
                for (let l in dataTotalWilayah.uttpAllObj) {
                    let persen = (dataTotalWilayah.uttpBlmTeraObj[l]/dataTotalWilayah.uttpAllObj[l])*100
                    strWilayah += `<tr><td>${l}</td><td>${persen.toFixed(2)} %</td><td>${dataTotalWilayah.uttpBlmTeraObj[l]}/${dataTotalWilayah.uttpAllObj[l]} unit</td></tr>`;
                }
                strWilayah += `</table>`;
                wilayahDiv.innerHTML += strWilayah;
                
                //console.log(dataTotal);

                let kategori = document.getElementById("kat");
                kategori.addEventListener('change', async () => {
                    let loading = document.querySelector('.ld0');
                    loading.hidden = false;
                    clearResultDisplayer();

                    switch($("#kat").val()) {
                        case 'wilayah' :
                            document.getElementById('detailKat').innerHTML = await getWilayah(); 
                            loading.hidden = true;
                            break;

                        case 'pasar' :
                            document.getElementById('detailKat').innerHTML = await getPasar();
                            loading.hidden = true;
                            break;

                        case '' :
                            loading.hidden = true;
                            document.getElementById('detailKat').innerHTML = `<option value=''>-- No Kategori Selected --</option>`;
                            break;
                    }

                    $("#detailKat").val('').trigger('change');

                    let detailKat = document.getElementById('detailKat');
                    detailKat.addEventListener('change', async () => {
                        loading.hidden = false;
                        clearResultDisplayer();
                        let resultDisplayer = document.querySelector('.resultDisplayer');
                        switch($("#kat").val()) {
                            case 'wilayah':
                                setTimeout(() => {
                                    let a = $("#detailKat").val().split(" - ");
                                    document.querySelector('.resultDisplayer').innerHTML = `Kel. ${a[0]} / Kec. ${a[1]}`; 
                                    loading.hidden = true;
                                }, 1800);
                                break;
                            case 'pasar':
                                setTimeout(async () => {
                                    let dataTotalPerPasar = await getTotalStatPerPasar($("#detailKat").val());
                                    resultDisplayer.innerHTML += `<h5>${$("#detailKat").val()}</h5>`;
                                    resultDisplayer.innerHTML += `<table class='thirdTable'>
                                        <tr><td>Total Uttp</td><td>${dataTotalPerPasar.totalStat.totalUttp} unit</td></tr>
                                        <tr><td>Total Uttp Sdh Tera</td><td>${dataTotalPerPasar.totalStat.totalUttpSdhTera} unit</td></tr>
                                        <tr><td>Persen Uttp Sdh Tera</td><td>${dataTotalPerPasar.totalStat.persenSdhTera} %</td></tr>
                                    </table>`;
                                    let str = `<table class='forthTable'><tr><th colspan=3 align="center">Jml Uttp Yang Belum Tera<th></tr>`;
                                    for (k in dataTotalPerPasar.uttpAllObj) {
                                        let persen = (dataTotalPerPasar.uttpBlmTeraObj[k]/dataTotalPerPasar.uttpAllObj[k])*100
                                        str += `<tr><td>${k}</td><td>${persen.toFixed(2)} %</td><td>${dataTotalPerPasar.uttpBlmTeraObj[k]}/${dataTotalPerPasar.uttpAllObj[k]} unit</td></tr>`;
                                    }
                                    str += `</table>`;
                                    resultDisplayer.innerHTML += str;

                                    loading.hidden = true;
                                }, 1800);
                                break;
                        }

                    });
                });
            })();


        </script>
    </body>
</html>