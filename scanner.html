<html>
    <head>

    </head>
    <body>
        <video id="video" autoplay></video>
        <!--
        <div class="spinner-border m-5 d-none" role="status" data-role="none">
            <span class="visually-hidden">Loading...</span>
        </div>
        -->
        <h4 id="qrcode_str" style="color : red;"></h4>
        <h4 id="qrcode_str_from_webapp" style="color : blue;"></h4>
        <script language="javascript">
			function sendData(dataObj) {
				const webAppUrl = "https://script.google.com/macros/s/AKfycbxZiAmLt7xoRtLzOGVak4LeYEWE7UAjSvLA73uzzSZA9O0cMIt5IiETisMmYqs8yM53wg/exec";

                const container_hasil_from_webapp = document.querySelector('#qrcode_str_from_webapp');

                fetch(webAppUrl,{
					method : 'POST',
					body : JSON.stringify(dataObj)
				}).then(respon => respon.json()).then(respon => {
					let pesan = respon.result;
                    container_hasil_from_webapp.innerHTML = "";
                    container_hasil_from_webapp.innerHTML = pesan;
					
				});

			}            
        </script>
        <script language="javascript" async>
            const video = document.querySelector("#video");
            //Check if device has camera
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const constrain = {
                    video : {
                        facingMode : {
                            exact: 'environment'
                        }
                    },
                    audio : false   
                }

                //start video stream
                navigator.mediaDevices.getUserMedia(constrain).then(stream => video.srcObject = stream);

                const container_hasil = document.querySelector('#qrcode_str');

                //Mendklarasi class barcode detector
                const qrcodeDetector = new BarcodeDetector({ formats : ['qr_code'] });

                const deteksiKode = () => {
                    //Mulai mendeteksi qrcode
                    qrcodeDetector.detect(video).then(codes => {
                        
                        if (codes.length === 0) return;
                        
                        for (const qrcode of codes) {
                            let dataObjToSend = {kode_qr : qrcode.rawValue};
                            sendData(dataObjToSend);
                            
                            container_hasil.innerHTML = "";
                            container_hasil.innerHTML = qrcode.rawValue;
                            
                        }
                        
                    })
                    .catch(err => {
                        container_hasil.innerHTML = "";
                        container_hasil.innerHTML = "Maaf, Kode tidak terbaca";
                    });
                }

                setInterval(deteksiKode, 1000);
            }
        </script>
    </body>
</html>