<html>
    <head>
	    <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="scanner.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    </head>
    <body>
	    <div class="container py-5 my-2 border" data-role="page" id="page6" width="640" height="480" style="text-align: center;">
			<div class="d-flex align-items-center konten" style="background-color : #52B2BF;color : #FFFFFF;">
				<strong id="qrcode_str"></strong>
				<div class="spinner-border ml-auto spinner" role="status" aria-hidden="true" hidden></div>
			</div>
			<div>
				<video id="video" autoplay width="100%" height="70%"></video>
			</div>
        </div>

		<script language="javascript">
            
			function sendData(dataObj) {
				//const webAppUrl = "https://script.google.com/macros/s/AKfycby7Z_DkeiHpN83U7eQKY4bLFrfHJk4mDIONmWhF8e8nYmwInOwqylXG7i2zi7OJYnqBBg/exec";

                //const webAppUrl = "https://script.google.com/macros/s/AKfycbxfbUnDkY7TMTfuTG65gGvjdTopUqlu8Co72qJZkpuknv5ZN3wGJ5QJO_Z7CuORMWUS/exec";

				// The last change 29_03_2022 const webAppUrl = "https://script.google.com/macros/s/AKfycbxa3B25ROWCWUTdb9e8Dh14TnUxFcVFT4-lJpOBHzXB29M9w71qCNGftpe1707XyUep/exec";

				//const webAppUrl = "https://script.google.com/macros/s/AKfycbxa3B25ROWCWUTdb9e8Dh14TnUxFcVFT4-lJpOBHzXB29M9w71qCNGftpe1707XyUep/exec";
				
				const webAppUrl = "https://script.google.com/macros/s/AKfycbyfbXf22BtHo3md83uvzPqOB_wL2NhX8MFrYiZLOT2Rv-RMTc93J_4oXCWaXOmYNfC7Bw/exec";

                const container_hasil_from_webapp = document.querySelector('#qrcode_str');
				const kontenDiv = document.querySelector('.konten');
				return new Promise((resolve,reject) => {
					fetch(webAppUrl,{
						method : 'POST',
						body : JSON.stringify(dataObj)
					})
					.then(respon => respon.json()).then(respon => {
						kontenDiv.style = "background-color : #FFFFFF";
						container_hasil_from_webapp.innerHTML = "";
						container_hasil_from_webapp.innerHTML = 
							`<table class='dataTabel'>
								<thead>
									<tr class='tHead'><th colspan='2'>Data UTTP</th></tr>
								</thead>
								<tbody class='tBody'>
									<tr><td>QRCode</td><td>${respon.kode}</td></tr>
									<tr><td>UTTP</td><td>${respon.uttp}</td></tr>
									<tr><td>Pemilik/WTU</td><td>${respon.wtu}</td></tr>
									<tr><td>Pasar</td><td>${respon.pasar}</td></tr>
									<tr><td>Tahun Tera</td><td>${respon.status_tera}</td></tr>
									<tr><td>Tanggal Ditera Terakhir</td><td>.........</td></tr>
								</tbody>
							</table>`
						resolve('done');
					})
					.catch(err => {
						container_hasil_from_webapp.innerHTML = "";
						container_hasil_from_webapp.innerHTML = "Data Untuk Kode ini Tidak Diketemukan";
						reject('Not done');
					});

				});

			}    
        </script>

		<script>			
			function jeda(waktu) {
				return new Promise((resolve) => {
					setTimeout(() => {
						resolve('Done');
					},waktu);
				});
			}
			
			function prepareTheCam(video) {
				const constrain = {
					video : {
						facingMode : {
							exact: 'environment'
						}
					},
					audio : false   
				}

				return navigator.mediaDevices.getUserMedia(constrain).then(stream => video.srcObject = stream);				
			}
			
			function tampilkanHasil(container_hasil,msg) {
				container_hasil.innerHTML = "";
				container_hasil.innerHTML = msg;
			}

			function pindai(video,container_hasil,enable_spinner) {
				const qrcodeDetector = new BarcodeDetector({formats : ['qr_code']});
				return new Promise((resolve, reject) => {
					const intervalID = setInterval(() => {
						qrcodeDetector.detect(video).then(async (codes) => {
							if (codes.length === 0) return;
							container_hasil.innerHTML = "QRCode terdeteksi";
							await jeda(800);
							container_hasil.innerHTML = "Sedang Memindai...";
							enable_spinner.hidden = false;
							await jeda(2000);
							
							for (const qrcode of codes) {
								var code = qrcode.rawValue;
							} 
							clearInterval(intervalID);
							resolve(code);
							//enable_spinner.hidden = true;
						})
						.catch(e => {
							clearInterval(intervalID);
							reject(e);
						});
					},2900);
				});

			}

			async function mainScanProcess() {
				let data = '';
				const container_hasil = document.querySelector('#qrcode_str');
				const enable_spinner = document.querySelector('.spinner');
				if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
					try {
						const theCam = await prepareTheCam(video);
						container_hasil.innerHTML = "Kamera siap...";
						await jeda(700);
						container_hasil.innerHTML = "Pemindai siap...";
						await jeda(700);
						container_hasil.innerHTML = "Silahkan memindai QRCode..";
						
						const pindai_ = pindai(video,container_hasil,enable_spinner);	

						await pindai_.then(async msg => {
							data = {'kode_qr' : msg};
							const kirimDataDanTunggu = sendData(data);
							await kirimDataDanTunggu.then(async () => {
								enable_spinner.hidden = true;
								await jeda(500);
								theCam.getTracks().forEach(track => track.stop());
							});
						})
						.catch(e => {
							tampilkanHasil(container_hasil,e);
							theCam.getTracks().forEach(track => track.stop());
						});
					}
					catch(err) {
						alert(err);
					}
				}
			}
			
			mainScanProcess();
		</script>

    </body>
</html>