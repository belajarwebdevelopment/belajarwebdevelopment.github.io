<html>
    <head>
        <!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">-->
    </head>
    <body>
        <video id="video" autoplay></video>
        <!--
        <div class="spinner-border m-5 d-none" role="status" data-role="none">
            <span class="visually-hidden">Reading data...</span>
        </div>
        -->
        <h2 id="qrcode_str" style="color : red;"></h2>
        <h2 id="qrcode_str_from_webapp" style="color : blue;"></h2>
        <script language="javascript">
            
			function sendData(dataObj) {
				//const webAppUrl = "https://script.google.com/macros/s/AKfycby7Z_DkeiHpN83U7eQKY4bLFrfHJk4mDIONmWhF8e8nYmwInOwqylXG7i2zi7OJYnqBBg/exec";

                //const webAppUrl = "https://script.google.com/macros/s/AKfycbxfbUnDkY7TMTfuTG65gGvjdTopUqlu8Co72qJZkpuknv5ZN3wGJ5QJO_Z7CuORMWUS/exec";

				const webAppUrl = "https://script.google.com/macros/s/AKfycbxa3B25ROWCWUTdb9e8Dh14TnUxFcVFT4-lJpOBHzXB29M9w71qCNGftpe1707XyUep/exec";

                const container_hasil_from_webapp = document.querySelector('#qrcode_str_from_webapp');
                //document.getElementById('entry_the_data').classList.toggle('d-none');
                fetch(webAppUrl,{
					method : 'POST',
					body : JSON.stringify(dataObj)
				}).then(respon => respon.json()).then(respon => {
					//let pesan = respon.result;
                    container_hasil_from_webapp.innerHTML = "";
                    container_hasil_from_webapp.innerHTML = "<ul><li>Kode : "+respon.kode+"</li><li>WTU : "+respon.wtu+"</li><li>Pasar : "+respon.pasar+"</li><li>UTTP : "+respon.uttp+"</li><li>Status : "+respon.status_tera+"</li></ul>";
					
				})
				.catch(err => {
					container_hasil_from_webapp.innerHTML = "";
					container_hasil_from_webapp.innerHTML = "Data Untuk Kode ini Tidak Diketemukan";
				});

			}    
            
            //sendData({kode_qr : "prlegi0005"});
        </script>
        <script language="javascript" async>
            function prepareTheCam() {
				const video = document.querySelector("#video");
				//Check if device has camera
				if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
					const constrain = {
						video : {
							facingMode : {
								exact: 'environment'
							}
						},
						audio : false   
					}

					//start video stream
					const my_stream = navigator.mediaDevices.getUserMedia(constrain).then(stream => video.srcObject = stream);

					const container_hasil = document.querySelector('#qrcode_str');

					//Mendklarasi class barcode detector
					const qrcodeDetector = new BarcodeDetector({ formats : ['qr_code'] });

					const deteksiKode = () => {
						//Mulai mendeteksi qrcode
						qrcodeDetector.detect(video).then(codes => {
							
							if (codes.length === 0) return;
							
							for (const qrcode of codes) {
								let dataObjToSend = {kode_qr : qrcode.rawValue};
								sendData(dataObjToSend);
								
								container_hasil.innerHTML = "";
								container_hasil.innerHTML = qrcode.rawValue;
								
							}
							clearInterval(setInterval_ID);
							my_stream.getTracks().forEach(function(track) {
								track.stop();
							});
							//navigator.mediaDevices.getUserMedia(constrain).getTracks().forEach(function(track) {
								//track.stop();
							//});
						})
						.catch(err => {
							container_hasil.innerHTML = "";
							container_hasil.innerHTML = "Maaf, Kode tidak terbaca";
							clearInterval(setInterval_ID);
							my_stream.getTracks().forEach(function(track) {
								track.stop();
							});
							//navigator.mediaDevices.getUserMedia(constrain).getTracks().forEach(function(track) {
								//track.stop();
							//});

						});
					}

					var setInterval_ID = setInterval(deteksiKode, 1000);
				}
				
			} 
			
			prepareTheCam();
/*
            const video = document.querySelector("#video");
            //Check if device has camera
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const constrain = {
                    video : {
                        facingMode : {
                            exact: 'environment'
                        }
                    },
                    audio : false   
                }

                //start video stream
                navigator.mediaDevices.getUserMedia(constrain).then(stream => video.srcObject = stream);

                const container_hasil = document.querySelector('#qrcode_str');

                //Mendklarasi class barcode detector
                const qrcodeDetector = new BarcodeDetector({ formats : ['qr_code'] });

                const deteksiKode = () => {
                    //Mulai mendeteksi qrcode
                    qrcodeDetector.detect(video).then(codes => {
                        
                        if (codes.length === 0) return;
                        
                        for (const qrcode of codes) {
                            let dataObjToSend = {kode_qr : qrcode.rawValue};
                            sendData(dataObjToSend);
                            
                            container_hasil.innerHTML = "";
                            container_hasil.innerHTML = qrcode.rawValue;
                            
                        }
                        
                    })
                    .catch(err => {
                        container_hasil.innerHTML = "";
                        container_hasil.innerHTML = "Maaf, Kode tidak terbaca";
                    });
                }

                setInterval(deteksiKode, 1000);
            }
*/            
        </script>
    </body>
</html>