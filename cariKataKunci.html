<html>
    <head>
	    <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="keywords" content="QRCode scanner, pendataan UTTP, metrologi surakarta">
		<meta name="description" content="Aplikasi Pendataan UTTP di Kota Surakarta">
		<link rel="stylesheet" href="scanner.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">

    </head>
    <body>
		<div class="topMenu">
			<nav id="navigasi">
				<a class="active" href="https://belajarwebdevelopment.github.io/index.html">Menu Utama</a> | 
				<a class="active" href="https://belajarwebdevelopment.github.io/scanner.html">Scan & Tandai Tera</a> |
                <a class="active" href="https://belajarwebdevelopment.github.io/index2.html?sendMeBack=yes">Ganti Pasar</a>
                <!--<a class="active" href="http://localhost/belajarwebdevelopment.github.io/index2.html?sendMeBack=yes">Ganti Pasar</a>-->
                <!--<a class="active" href="E:/xampp/htdocs/belajarwebdevelopment.github.io/index2.html?sendMeBack=yes">Ganti Pasar</a>-->
            </nav>
        </div>
	    <div class="container py-5 my-2 border" data-role="page" id="page6" width="640" height="480" style="text-align: center;">
			<div class="title"><h2 class="banner">Cari Dgn Kata Kunci</h2><h5 class="banner">Lokasi :  <span id="namaLokasi"></span></h5></div>
            <div class="kontainer">
                <article id="keterangan">
                    Kata kunci bisa berupa :
                    <ul>
                        <li>nomor Qrcode; atau</li>
                        <li>nama pedagang;</li>    
                    </ul>
                </article>
                Masukkan kata kunci : <br>
                <input type="text" name="katakunci" id="katakunci" width="90%">
                <button type="submit" class="cari">Cari</button>
                <button type="button" class="button" hidden>
                    <span class="button__text">Loading</span>
                </button>
            </div><br>
            <div class="kontainer penampilHasil">
                <p id="keterangan2"><b>Hasil Pencarian</b></p>
                <div class="resultView"></div>
            </div>
            <br>
            <div class="scanner" hidden>
                <h3 class="judul">Pindai QRCode Yg Baru</h3>
                <h6 class="header"></h6>
                <div class="camContainer">
                    <video id="video" autoplay></video>
                </div>
            </div>
        </div>
		<footer>

		</footer>
		<script language="javascript">
            function sendGetData(keyword) {
                               
                const webAppUrl = "https://script.google.com/macros/s/AKfycbwjZfnxH3YT9KSxuSd_culu_iIYPdbVQrpWlyVAfn-9PFrKJERJuF01z8SlLrYj2Vku/exec";

                let h = new Headers();
                h.set('Content-Type','text/plain;charset=UTF-8');
                h.set('Accept','application/json; charset=utf-8');
                return fetch(webAppUrl, {
                    method : 'POST',
                    headers : h,
                    body : JSON.stringify({'keyword' : keyword, 'pasar' : localStorage.getItem('pasar')})
                })
                .then(respon => respon.json())
                .then(respon => {
                    if (respon.error_msg === "Data tidak ditemukan.....") {
                        throw respon.error_msg;
                    } 
                    if(respon.result === "error") {
                        throw "Server error : error 500";
                    }
                    
                    return respon;
                })
                .catch(e => {
                    return {'error_msg' : e};
                }
                );

                /*
                return new Promise((resolve, reject) => {
                    fetch(webAppUrl, {
                        method : 'POST',
                        headers : h,
                        body : JSON.stringify({'keyword' : keyword, 'pasar' : localStorage.getItem('pasar')})
                    })
                    .then(respon => respon.json())
                    .then(respon => resolve(respon))
                    .catch(e => reject(e));
                });
                */
            }

            const tombolCari = document.querySelector('.cari');
            const tombolLoading = document.querySelector('.button');

            function preLoading() {
                tombolCari.hidden = true;
                tombolLoading.classList.add('button--loading');
                tombolLoading.hidden = false;
            }

            function afterLoading() {
                tombolCari.hidden = false;
                tombolLoading.hidden = true;
                tombolLoading.classList.remove('button--loading');
            }

            function tampilkanHasil(datas) {
                let kontenDiv = document.querySelector('.resultView');
                let str = '';
                let i = 1;

                for (let k in datas) {
                
                    i % 2 == 0 ? className = 'even' : className = 'odd';
                
                    //let item = datas['data'][k];
                    let item = datas[k];
                    let nama_komoditi = `${item[3]} - ${item[16]}`;
                    let uttp_merk_model = `${item[8]} ${item[9]}/${item[10]} - ${item[11]} - ${item[12]}`;

                    str += `
                        <div id=${k} class='divItem ${className} c${k}'>
                            <table class='theTable'>
                                <tr><td>Nama - Komoditi</td><td>:</td><td>${nama_komoditi}</td></tr>
                                <tr><td>Pasar</td><td>:</td><td>${item[2]}</td></tr>
                                <tr><td>Phone</td><td>:</td><td>${item[5]}</td></tr>
                                <tr><td>QRCode</td><td>:</td><td>${item[1]}</td></tr>
                                <tr><td>UTTP-Merk-Model</td><td>:</td><td>${uttp_merk_model}</td></tr>
                                <tr><td>Tahun Tera</td><td>:</td><td>${item[13]}</td></tr>
                                <tr><td></td><td></td><td></td></tr>
                            </table>
                            <button type='submit' class='itemUbahBtn itemUbahBtn${k}' id='ubah-${k}'>Ubah QRCode</button>
                            <button type='submit' class='itemUpdateBtn itemUpdateBtn${k}' id=${k}>Tandai Tera</button>
                        </div>
                    `;
                    i++;                       
                }
                kontenDiv.innerHTML = str;
            }

            function tampilkanError(datas) {
                let kontenDiv = document.querySelector('.resultView');
                kontenDiv.innerHTML = `<h3 style='color : red; background-color : black;'>${datas.error_msg}</h3>`;
            }

            function clearKonten(className) {
                let kontenDiv = document.querySelector(`.${className}`);
                kontenDiv.innerHTML = "";
            }

            function sendUpdateTera(nomorBaris) {
                const webAppUrl2 = "https://script.google.com/macros/s/AKfycbwH8p27fMICiKfnJD0myvvIg1-hir6PHHcNZ-JSyQbZJOywjydWNarWyM8_VnFaS8Rx/exec";

                return fetch(webAppUrl2, {
                    method : 'POST',
                    body : JSON.stringify({'nomorBaris' : nomorBaris})
                })
                .then(resp => resp.json())
                .then(resp => resp)
                .catch(e => e);

                /*
                return new Promise((resolve, reject) => {
                    fetch(webAppUrl2, {
                        method : 'POST',
                        body : JSON.stringify({'nomorBaris' : nomorBaris})
                    })
                    .then(resp => resp.json())
                    .then(resp => resolve(resp))
                    .catch(e => reject(e));
                });
                */
            }

            function sendNewQRCode(nomorBaris, newQRCode) {
                //Latest version 26 Okt 2022
                //const webAppUrl3 = "https://script.google.com/macros/s/AKfycby_uNKxXq0DS5wqa8KoUWPnrF6jTgHEXFG5F58t3qvKasfd_ot5epBNX3l4b5xV2C0v/exec";
                
                const webAppUrl3 = "https://script.google.com/macros/s/AKfycbzT2VX0ZR48CRKDe3-iP2Xk9z_otUFgxHkmMlqK4OCNleflZiVmBx_D983vmR8J9-WO/exec";

                return fetch(webAppUrl3, {
                    method : 'POST',
                    body : JSON.stringify({'nomorBaris' : nomorBaris, 'newQRCode' : newQRCode})
                })
                .then(resp => resp.json())
                .then(resp => {
                    if (resp.result === "error") {
                        throw `Error 400 : ${resp.msg}`;
                    }
                    return resp;
                })
                .catch(e => `<span style='color : red;'>Error : Update QRCode Baru Gagal -> </span><br><span style='color : red;'>${e}</span>`);

                /*
                return new Promise((resolve, reject) => {
                    fetch(webAppUrl3, {
                        method : 'POST',
                        body : JSON.stringify({'nomorBaris' : nomorBaris, 'newQRCode' : newQRCode})
                    })
                    .then(resp => resp.json())
                    .then(resp => resolve({'result' : true, 'data' : resp}))
                    .catch(e => reject({'result' : false}));
                });
                */
            }

            function hideScanner() {
                document.querySelector('.camContainer').hidden = true;
            }

            function hideExceptScanner(logic = true) {
                document.querySelector('.penampilHasil').hidden = logic;
                document.querySelector('.title').hidden = logic;
                document.querySelector('.kontainer').hidden = logic;
                document.querySelector('.scanner').hidden = !logic;
            }

            function showExceptScanner(logic = true) {
                document.querySelector('.penampilHasil').hidden = !logic;
                document.querySelector('.title').hidden = !logic;
                document.querySelector('.kontainer').hidden = !logic;
                document.querySelector('.scanner').hidden = logic;
            }

            function btnLoading(rowNum) {
                document.querySelector('.c'+rowNum).classList.add('button--loading--table');
                document.querySelector('.itemUpdateBtn'+rowNum).classList.add('button--loading');
                document.querySelector('.itemUpdateBtn'+rowNum).innerHTML = "Updating...";
            }

            function jeda(waktu) {
				return new Promise((resolve) => {
					setTimeout(() => {
						resolve('Done');
					},waktu);
				});
			}

			function prepareTheCam(video) {
				const constrain = {
					video : {
						facingMode : {
							exact: 'environment'
						}
					},
					audio : false   
				}

				return navigator.mediaDevices.getUserMedia(constrain).then(stream => video.srcObject = stream);							
			}

			function pindai(video,container_hasil) {
				const qrcodeDetector = new BarcodeDetector({formats : ['qr_code']});
                return new Promise((resolve, reject) => {
					const intervalID = setInterval(() => {
						qrcodeDetector.detect(video).then(async (codes) => {
							if (codes.length === 0) return;
							container_hasil.innerHTML = "QRCode terdeteksi";
							await jeda(400);
							container_hasil.innerHTML = "Sedang Memindai...";
							await jeda(900);
							
							for (const qrcode of codes) {
								var code = qrcode.rawValue;
							} 
							clearInterval(intervalID);
							resolve(code);
						})
						.catch(e => {
							clearInterval(intervalID);
							reject(e);
						});
					},2900);
				});
			}

			async function mainScanProcess(barisKe) {
				let data = '';
				const container_hasil = document.querySelector('.header');
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
					try {
						const theCam = await prepareTheCam(video);
                        hideExceptScanner();
						container_hasil.innerHTML = "Kamera siap...";
						await jeda(500);
						container_hasil.innerHTML = "Pemindai siap...";
						await jeda(500);
						container_hasil.innerHTML = "Silahkan memindai QRCode..";
						
						const pindai_ = pindai(video,container_hasil);	

						await pindai_.then(async kodeQr => {
                            const ubahQRCode = await sendNewQRCode(barisKe,kodeQr);
                            let resultStr = '';
                            //alert(`Data : ${ubahQRCode.dataAfter[barisKe]}`);
                            if (ubahQRCode.result === "success") {
                                
                                resultStr = `Ganti QRCode nya ${ubahQRCode.result} !<br>
                                <table id='gantiQR'>
                                <tr>
                                    <td>ID </td><td>: ${ubahQRCode.dataAfter[barisKe][3]}</td>
                                <tr>
                                <tr>
                                    <td>Pasar</td><td>: ${ubahQRCode.dataAfter[barisKe][2]}</td>
                                </tr>
                                <tr>
                                    <td>Komoditi</td><td>: ${ubahQRCode.dataAfter[barisKe][16]}</td>
                                </tr>
                                <tr>
                                    <td>Old QRCode</td><td>: ${ubahQRCode.dataBefore[barisKe][1]}</td>
                                </tr>
                                <tr>    
                                    <td>New QRCode</td><td>: ${ubahQRCode.dataAfter[barisKe][1]}</td>
                                </tr>
                                <tr><td colspan='2' align='center'><button class='backToPrev'>Kembali ke Halaman Pencarian</button></td></tr>
                                </table>
                                `;
                                
                            } else {
                                resultStr = `${ubahQRCode} <br><button class='reScan'>Scan QRCode Lain</button>`;
                            }

                            tampilkanHasil2(container_hasil,resultStr);

                            theCam.getTracks().forEach(track => track.stop());
                            hideScanner();
                            //alert(msg);
							//data = {'kode_qr' : msg};
                            //container_hasil.innerHTML = data.kode_qr;
                            /*await jeda(200);
							const ubahQRCode = await sendNewQRCode(msg);
                            alert(ubahQRCode.dataAfter);
                            theCam.getTracks().forEach(track => track.stop());
                            */
                            
						})
						.catch(e => {
							tampilkanHasil2(container_hasil,e);
							theCam.getTracks().forEach(track => track.stop());
						});
					}
					catch(err) {
						alert(err);
					}
				}
			}

			function tampilkanHasil2(container_hasil,msg) {
				container_hasil.innerHTML = "";
				container_hasil.innerHTML = msg;
			}

//############################################# - Main Program - ###############################################//
            tombolCari.addEventListener('click',async () => {
                let keyword = document.getElementById('katakunci').value;
                clearKonten('resultView');
                preLoading();
                let datas = await sendGetData(keyword);
                afterLoading();
                datas.result === "success" ? tampilkanHasil(datas.data) : tampilkanError(datas);
            });

            document.querySelector('.resultView').addEventListener('click', async e => {
                let barisKe = e.target.id;
                if (e.target.classList.contains('itemUpdateBtn')) {
                    btnLoading(barisKe);
                    let doUpdateTera = await sendUpdateTera(barisKe);
                    doUpdateTera.result === 'error' ? tampilkanError(doUpdateTera) : tampilkanHasil(doUpdateTera['dataAfter']);
                }

            });

            
            let tombolUbahQrcode = document.querySelector('.resultView'); 
            tombolUbahQrcode.addEventListener('click', async e => {
                //alert('Ubah QRCode');
                let barisKe = e.target.id.split("-")[1].trim();
                if (e.target.classList.contains('itemUbahBtn')) {
                    mainScanProcess(barisKe);
                }

                if (e.target.classList.contains('itemUbahBtn')) {
                    alert('re Scan guys');
                }    
            });

            //document.getElementById('prev').addEventListener('click',() => showExceptScanner());
            document.querySelector('.header').addEventListener('click', e => {
                //alert(e.classList.contains('backToPrev'));
                e.target.classList.contains('backToPrev') ? window.open('https://belajarwebdevelopment.github.io/cariKataKunci.html', '_self') : '';
            })
            
            if (!localStorage.getItem('pasar')) {
                let strParam = `?sendMeBack=yes`;
                //window.open('http://locahost/belajarwebdevelopment.github.io/index2.html'+strParam, '_self');
                window.open('https://belajarwebdevelopment.github.io/index2.html'+strParam, '_self');
                //window.open('E:/xampp/htdocs/belajarwebdevelopment.github.io/index2.html'+strParam, '_self');
            } 
            document.getElementById('namaLokasi').innerHTML = localStorage.getItem('pasar');
                    
        </script>    
    </body>
</html>