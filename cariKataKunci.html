<html>
    <head>
	    <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="keywords" content="QRCode scanner, pendataan UTTP, metrologi surakarta">
		<meta name="description" content="Aplikasi Pendataan UTTP di Kota Surakarta">
		<link rel="stylesheet" href="scanner.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">

    </head>
    <body>
		<div class="topMenu">
			<nav id="navigasi">
				<a class="active" href="https://belajarwebdevelopment.github.io/index.html">Menu Utama</a> | 
				<a class="active" href="https://belajarwebdevelopment.github.io/scanner.html">Scan & Tandai Tera</a> |
			</nav>
        </div>
	    <div class="container py-5 my-2 border" data-role="page" id="page6" width="640" height="480" style="text-align: center;">
			<div><h2 class="banner">Cari Dgn Kata Kunci</h2><h5 class="banner">Lokasi :  <span id="namaLokasi"></span></h5></div>
            <div class="kontainer">
                <article id="keterangan">
                    Kata kunci bisa berupa :
                    <ul>
                        <li>nomor Qrcode; atau</li>
                        <li>nama pedagang;</li>    
                    </ul>
                </article>
                Masukkan kata kunci : <br>
                <input type="text" name="katakunci" id="katakunci" width="90%">
                <button type="submit" class="cari">Cari</button>
                <button type="button" class="button" hidden>
                    <span class="button__text">Loading</span>
                </button>
            </div><br>
            <div class="kontainer">
                <p id="keterangan2"><b>Hasil Pencarian</b></p>
                <div class="resultView"></div>
            </div>
        </div>
		<footer>

		</footer>
		<script language="javascript">
            function sendGetData(keyword) {
                //const webAppUrl = "https://script.google.com/macros/s/AKfycbwYXluDK-xlleFe5BCwTtQN1bzOwp78GIz_qlFwi4UVtkjS3n_015RoQICQ12v5JgEHXw/exec";

                const webAppUrl = "https://script.google.com/macros/s/AKfycbwRWMj3Q0pqEGP05vzPB-YA6OstDCl1AdwwGSYCUFxLgeC08_s4PwjjVouI7X35dxeHjw/exec";

                return new Promise((resolve, reject) => {
                    fetch(webAppUrl, {
                        method : 'POST',
                        body : JSON.stringify({'keyword' : keyword})
                    })
                    .then(respon => respon.json())
                    .then(respon => resolve(respon))
                    .catch(e => reject(e));
                });
            }

            const tombolCari = document.querySelector('.cari');
            const tombolLoading = document.querySelector('.button');

            function preLoading() {
                tombolCari.hidden = true;
                tombolLoading.classList.add('button--loading');
                tombolLoading.hidden = false;
            }

            function afterLoading() {
                tombolCari.hidden = false;
                tombolLoading.hidden = true;
                tombolLoading.classList.remove('button--loading');
            }

            function tampilkanHasil(datas) {
                let kontenDiv = document.querySelector('.resultView');
                let str = '';
                let i = 1;

                for (let k in datas['data']) {
                    //if (datas['data'][k][2] === localStorage.getItem('pasar')) {
                    
                    if (datas['data'][k][2].toLocaleLowerCase().includes(localStorage.getItem('pasar').toLocaleLowerCase())) 
                    {
                        i % 2 == 0 ? className = 'even' : className = 'odd';
                    
                        let item = datas['data'][k];
                        let nama_komoditi = `${item[3]} - ${item[16]}`;
                        let uttp_merk_model = `${item[8]} ${item[9]}/${item[10]} - ${item[11]} - ${item[12]}`;

                        str += `
                            <div id=${k} class='divItem ${className}''>
                                <table class='theTable'>
                                    <tr><td>Nama - Komoditi</td><td>:</td><td>${nama_komoditi}</td></tr>
                                    <tr><td>Pasar</td><td>:</td><td>${item[2]}</td></tr>
                                    <tr><td>Phone</td><td>:</td><td>${item[5]}</td></tr>
                                    <tr><td>QRCode</td><td>:</td><td>${item[1]}</td></tr>
                                    <tr><td>UTTP-Merk-Model</td><td>:</td><td>${uttp_merk_model}</td></tr>
                                    <tr><td>Tahun Tera</td><td>:</td><td>${item[13]}</td></tr>
                                    <tr><td></td><td></td><td></td></tr>
                                </table>
                                <button type='submit' class='itemUbahBtn' id='ubah-${k}'>Ubah QRCode</button>
                                <button type='submit' class='itemUpdateBtn' id=${k}>Tandai Tera</button>
                            </div>
                        `;
                        i++;                       
                    }
                }
                kontenDiv.innerHTML = str;
            }

            tombolCari.addEventListener('click',async () => {
                let keyword = document.getElementById('katakunci').value;
                preLoading();
                let datas = await sendGetData(keyword);
                afterLoading();
                tampilkanHasil(datas);
            });

            document.querySelector('.resultView').addEventListener('click', e => {
                e.target.classList.contains('itemUpdateBtn') ? console.log(e.target.id) : e.target.classList.contains('itemUbahBtn') ? console.log(e.target.id) : '';

            });

            if (!localStorage.getItem('pasar')) {
                let namaPasar = prompt('Masukkan nama pasar : ');
                localStorage.setItem('pasar', namaPasar);
            } 
            document.getElementById('namaLokasi').innerHTML = localStorage.getItem('pasar');
                    
        </script>    
    </body>
</html>